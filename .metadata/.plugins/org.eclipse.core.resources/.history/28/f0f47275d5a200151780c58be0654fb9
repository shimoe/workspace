#include "LPC13xx.h"
#include "gpio.h"
#include "vs-wrc103.h"
#include "ixbus.h"
#include <stdlib.h>

#define BLACK 800
#define LENGTH 256
#define POWER 12000
#define DIFF 5000



int sensor();
char* ary;

ary = (char* )malloc(1);


int main(void)
{
	const unsigned short MainCycle = 60;
	Init(MainCycle);

int i = 0;
char* tmp;

	while(1){


		switch(sensor()){
		case 0:while(1){
			   int left,right;
			   left = ADRead(0);
			   right = ADRead(1);

			   Mtr_Run_lv(POWER,-POWER,0,0,0,0);
		       ary[i] = 1;
		       if(left < BLACK && right < BLACK){
		    	   int j,sum;

		    	   sum = 0;
		    	   if(i > LENGTH){
		    	   for(j = i - LENGTH;j < i;j++){
		    		   sum = sum + (int)ary[j];
		    	   }
		    	   }

		    	   if(sum > LENGTH) Mtr_Run_lv(0,0,0,0,0,0);
		       }
		       i++;
		       }
		case 1:Mtr_Run_lv(POWER+DIFF,-POWER+DIFF,0,0,0,0);
		       ary[i] = 0;
		       i++;
		case 2:Mtr_Run_lv(POWER-DIFF,-POWER-DIFF,0,0,0,0);
		       ary[i] = 0;
		       i++;
		}

if(tmp = (char*)realloc(ary,i+1) != NULL){
ary = tmp;
}
	}
	return 0;
}

int sensor(){
	int right,left;

	left = ADRead(0);
	right = ADRead(1);

	if(left > BLACK && right > BLACK) return 0;
	else if(left > BLACK) return 1;
	else if(left < BLACK) return 2;
}
